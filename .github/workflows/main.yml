name: Terraform CI/CD
defaults:
  run:
    working-directory: dev
on:
  workflow_dispatch:
    inputs:
      working_directory:
        description: 'Carpeta de Terraform a desplegar'
        required: true
        type: choice
        options:
          - Orion
          - bancolombia
          - ruteandoelmundo
          - coca-cola
      environment:
        description: 'Ambiente a desplegar'
        required: true
        type: choice
        options:
          - dev
          - qa
          - prod
          - uat
      action:
        description: 'Acci√≥n de Terraform a ejecutar'
        required: true
        type: choice
        options:
          - apply
          - destroy
# Permisos necesarios para OIDC
permissions:
  id-token: write
  contents: read
  issues: write

jobs:
  terraform:
    name: Terraform ${{ github.event.inputs.action }}-${{ github.event.inputs.working_directory }} (${{ github.event.inputs.environment }})
    runs-on: ubuntu-latest

    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      TF_VAR_environment: ${{ github.event.inputs.environment }}
      WORKING_DIR: ${{ github.event.inputs.working_directory }}/${{ github.event.inputs.environment }}
      ENVIRONMENT: ${{ github.event.inputs.environment }}
      ACTION: ${{ github.event.inputs.action }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: üîç DEBUG - Ver estructura del repositorio
        run: |
          echo "üìÇ Contenido ra√≠z del repositorio:"
          ls -la
          echo ""
          echo "üìÇ Estructura completa (primeros 2 niveles):"
          find . -maxdepth 2 -type d
          echo ""
          echo "üîç Buscando carpeta: ${{ env.WORKING_DIR }}"
          if [ -d "${{ env.WORKING_DIR }}" ]; then
            echo "‚úÖ La carpeta ${{ env.WORKING_DIR }} EXISTE"
            ls -la "${{ env.WORKING_DIR }}"
          else
            echo "‚ùå La carpeta ${{ env.WORKING_DIR }} NO EXISTE"
          fi        

      - name: Display configuration
        run: |
          echo "üîß Configuraci√≥n del despliegue:"
          echo "  üìÅ Directorio: ${{ env.WORKING_DIR }}"
          echo "  üåç Ambiente: ${{ env.ENVIRONMENT }}"
          echo "  ‚ö° Acci√≥n: ${{ env.ACTION }}"

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}
          role-session-name: GHA-${{ env.ENVIRONMENT }}-${{ github.run_number }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Terraform Init    
        run: terraform init

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Plan
        run: terraform plan

      - name: Terraform Apply
        if: inputs.action == 'apply'
        run: terraform apply -auto-approve